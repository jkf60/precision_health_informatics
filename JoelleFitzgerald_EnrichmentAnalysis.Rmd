---
title: "JoelleFitzgerald_EnrichmentAnalysis"
author: "Joelle Fitzgerald"
date: "11/2/2022"
output: html_document
---

## Midterm Part 2: Enrichment Analysis 

## Goal 

To perform Enrichment Analysis in R with the help of the R package EnrichR.

```{r setup, include=FALSE}
# Installing appropriate packages
knitr::opts_chunk$set(echo = TRUE)
#install.packages("enrichR")
#install.packages("openxlsx")# independant of java
#install.packages("devtools") 
#devtools::install_github("wjawaid/enrichR")
library(enrichR)
library(openxlsx)

```

## Given

A set of T-Test results from a Gene expression group comparison analysis. This analysis was done on incipient and control (baseline) Alzheimer patient groups based on disease status. 

## Import T-test results so that we can short list further
```{r}
#folder that contains group comparison results
ContrlIncipient_tTest <- "output/Joelle_Fitzgerald_Control_Incipient_Ttest_Shortlisted.tsv"

# read in group comparison results
result1 <- read.table(file = ContrlIncipient_tTest, row.names = 1, sep="\t", header = TRUE , stringsAsFactors = F)
```

# Filtering/shortlisting based on p-value generated by t-Test 

Short list results based in p-value cut off (pvalue <= 0.01)

```{r}
pValueCutOff <- 0.01
which1 <- ((as.numeric(result1$Pvalue) <= pValueCutOff))
table(which1) #249 genes with p <= 0.01. 

resultShort <- result1[which1, ] #short listed genes 
head(resultShort)
```

## Clean gene names

```{r}
funcSplit <- function(rep_gene) {
    rep_gene_split <- unlist(strsplit(x = rep_gene, 
                                      split = "_at|", 
                                      fixed = TRUE))
    gene <- rep_gene_split[2]
    return(gene)
}
geneListSplit <- apply(X = as.matrix((resultShort$Feature)), 
                       MARGIN = 1, FUN = funcSplit ) # 294 genes
head(geneListSplit) #cleaned gene names

#remove duplicates
geneListSplit1 <- unique(geneListSplit) # 289 genes 

# remove NA value
geneListFinal <- na.omit(geneListSplit1) # 289 genes

#print number of unique genes
length(geneListFinal)
write.table(x = geneListFinal, 
          file = "output/JoelleFitzgerald_IncipientGroup_ControlGroup_DEGs.tsv",
          quote = F, sep = "\t", row.names = FALSE, col.names = F) # 289 genes


```

## Export the short listed results for reference

```{r}
#length of short listed results, 74 genes 
nrow(resultShort)

write.csv(x = resultShort, file = "output/TTest_results_shortlist2.csv")

```

## Load Databases for Enrichr R package and testing connection

```{r}
#checking if EnrichR website and packing are working
dbs <- enrichR::listEnrichrDbs()  #total number of databases available = 200+ 

#testing if EnrichR package is working
testOutput <- enrichR::enrichr(genes = c("Runx1", "Gfi1", "Gfi1b", "Spi1", "Gata1", "Kdr"), databases = "KEGG_2021_Human")
head(testOutput[[1]])

#List of databases for which enrichment analysis will be run
dblist1 <- read.csv(file = "code/input/2022-EnrichR-Databases.txt", 
                    header = F, stringsAsFactors = F)

head(dblist1)
```

## Calling the function to run Enrichment

```{r}
#```{r, message=FALSE, results = FALSE, warning=FALSE} #hide the logs
# set output file name
outputFile1 <- paste("output/JoelleFitzgerald_ComparisonGroupName_BaselinegroupName", "_EnrichR.xlsx", sep="")

#Load R script into the environment
source(file = "code/functionEnrichment.R") 

#call function to run Enrichment
functionEnrichment(dblist1, geneListFinal, outputFile1)

```
